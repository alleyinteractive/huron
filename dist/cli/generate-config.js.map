{"version":3,"sources":["../../src/cli/generate-config.js"],"names":["generateConfig","cwd","process","path","require","url","fs","defaultConfig","defaultHuron","webpack","HTMLWebpackPlugin","localHuron","join","huronConfig","config","newConfig","huron","Object","assign","configureEntries","configurePlugins","configureLoaders","configurePrototypes","output","resolve","root","devServer","production","publicPath","port","entry","concat","plugins","length","filter","plugin","constructor","name","HotModuleReplacementPlugin","NamedModulesPlugin","templatesLoader","templates","rule","include","module","rules","push","test","use","wrapperTemplate","readFileSync","__dirname","defaultHTMLPluginOptions","title","window","js","css","filename","template","inject","chunks","outputFileSync","prototypes","forEach","prototype","newPrototype","opts","hasOwnProperty","call","moveAdditionalAssets","keys","assets","subdir","currentAssets","assetResults","asset","assetInfo","parse","assetURL","sourcePath","outputPath","base","loadPath","contents","isAbsolute","protocol","e","console","warn"],"mappings":"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","file":"generate-config.js","sourcesContent":["/** @module cli/generate-config */\n\nimport program from './parse-args';\n\nconst cwd = process.cwd();\nconst path = require('path');\nconst url = require('url');\nconst fs = require('fs-extra');\nconst defaultConfig = require('../../config/webpack.config');\nconst defaultHuron = require('../../config/huron.config');\nconst webpack = require('webpack');\nconst HTMLWebpackPlugin = require('html-webpack-plugin');\n\n/* eslint-disable import/no-dynamic-require */\nconst localHuron = require(path.join(cwd, program.huronConfig));\n/* eslint-enable */\n\n/**\n * Generate a mutant hybrid of the huron default webpack config and your local webpack config\n *\n * @function generateConfig\n * @param {object} config - local webpack config\n * @return {object} newConfig - updated data store\n */\nexport default function generateConfig(config) {\n  let newConfig = config;\n  const huron = Object.assign({}, defaultHuron, localHuron);\n\n  // configure entries\n  newConfig = configureEntries(huron, newConfig);\n\n  // configure plugins\n  newConfig = configurePlugins(huron, newConfig);\n\n  // configure loaders\n  newConfig = configureLoaders(huron, newConfig);\n\n  // Add HTMLWebpackPlugin for each configured prototype\n  newConfig = configurePrototypes(huron, newConfig);\n\n  // Set ouput options\n  newConfig.output = Object.assign({}, newConfig.output, defaultConfig.output);\n  newConfig.output.path = path.resolve(cwd, huron.root);\n\n  // Remove existing devServer settings\n  delete newConfig.devServer;\n\n  // Set publicPath\n  if (! program.production) {\n    newConfig.output.publicPath = `http://localhost:${huron.port}/${huron.root}`;\n  } else {\n    newConfig.output.publicPath = '';\n  }\n\n  return {\n    huron,\n    webpack: newConfig,\n  };\n}\n\n/**\n * Configure and manage webpack entry points\n *\n * @param {object} huron - huron configuration object\n * @param {object} config - webpack configuration object\n * @return {object} newConfig - updated data store\n */\nfunction configureEntries(huron, config) {\n  const entry = config.entry[huron.entry];\n  const newConfig = config;\n\n  newConfig.entry = {};\n\n  if (! program.production) {\n    newConfig.entry[huron.entry] = [\n      `webpack-dev-server/client?http://localhost:${huron.port}`,\n      'webpack/hot/dev-server',\n      path.join(cwd, huron.root, 'huron-assets/huron'),\n    ].concat(entry);\n  } else {\n    newConfig.entry[huron.entry] = [\n      path.join(cwd, huron.root, 'huron-assets/huron'),\n    ].concat(entry);\n  }\n\n  return newConfig;\n}\n\n/**\n * Configure and manage webpack plugins\n *\n * @param {object} huron - huron configuration object\n * @param {object} config - webpack configuration object\n * @return {object} newConfig - updated data store\n */\nfunction configurePlugins(huron, config) {\n  const newConfig = config;\n\n  newConfig.plugins = config.plugins || [];\n\n  if (! program.production) {\n    if (newConfig.plugins && newConfig.plugins.length) {\n      newConfig.plugins = newConfig.plugins.filter(\n        (plugin) => 'HotModuleReplacementPlugin' !== plugin.constructor.name &&\n          'NamedModulesPlugin' !== plugin.constructor.name\n      );\n    }\n    newConfig.plugins = newConfig.plugins\n      .concat([\n        new webpack.HotModuleReplacementPlugin(),\n        new webpack.NamedModulesPlugin(),\n      ]);\n  }\n\n  return newConfig;\n}\n\n/**\n * Configure and manage webpack loaders\n *\n * @param {object} huron - huron configuration object\n * @param {object} config - webpack configuration object\n * @return {object} newConfig - updated data store\n */\nfunction configureLoaders(huron, config) {\n  // Manage loaders\n  const templatesLoader = huron.templates.rule || {};\n  const newConfig = config;\n\n  templatesLoader.include = [path.join(cwd, huron.root)];\n  newConfig.module = newConfig.module || {};\n  newConfig.module.rules = newConfig.module.rules || [];\n  newConfig.module.rules.push(\n    {\n      test: /\\.html$/,\n      use: 'html-loader',\n      include: [path.join(cwd, huron.root)],\n    },\n    {\n      test: /\\.json$/,\n      use: 'json-loader',\n      include: [path.join(cwd, huron.root)],\n    },\n    templatesLoader\n  );\n\n  return newConfig;\n}\n\n/**\n * Create an HTML webpack plugin for each configured prototype\n *\n * @param {object} huron - huron configuration object\n * @param {object} config - webpack configuration object\n * @return {object} newConfig - updated data store\n */\nfunction configurePrototypes(huron, config) {\n  const wrapperTemplate = fs.readFileSync(\n    path.join(__dirname, '../../templates/prototype-template.ejs'),\n    'utf8'\n  );\n  const defaultHTMLPluginOptions = {\n    title: '',\n    window: huron.window,\n    js: [],\n    css: [],\n    filename: 'index.html',\n    template: path.join(huron.root, 'huron-assets/prototype-template.ejs'),\n    inject: false,\n    chunks: [huron.entry],\n  };\n  const newConfig = config;\n\n  // Write prototype template file for HTML webpack plugin\n  fs.outputFileSync(\n    path.join(cwd, huron.root, 'huron-assets/prototype-template.ejs'),\n    wrapperTemplate\n  );\n\n  huron.prototypes.forEach((prototype) => {\n    const newPrototype = prototype;\n    let opts = {};\n\n    // Merge configured settings with default settings\n    if ('string' === typeof prototype) {\n      opts = Object.assign({}, defaultHTMLPluginOptions, {\n        title: prototype,\n        filename: `${prototype}.html`,\n      });\n    } else if (\n      'object' === typeof prototype &&\n      {}.hasOwnProperty.call(prototype, 'title')\n    ) {\n      // Create filename based on configured title if not provided\n      if (! prototype.filename) {\n        newPrototype.filename = `${prototype.title}.html`;\n      }\n\n      // Move css assets for this prototype,\n      // reset css option with new file paths\n      if (prototype.css) {\n        newPrototype.css = moveAdditionalAssets(prototype.css, 'css', huron);\n      }\n\n      // Move js assets for this prototype,\n      // reset js option with new file paths\n      if (prototype.js) {\n        newPrototype.js = moveAdditionalAssets(prototype.js, 'js', huron);\n      }\n\n      opts = Object.assign({}, defaultHTMLPluginOptions, newPrototype);\n    }\n\n    // Move global css assets,\n    // reset css option with new file paths\n    if (huron.css.length) {\n      opts.css = opts.css.concat(\n        moveAdditionalAssets(huron.css, 'css', huron)\n      );\n    }\n\n    // Move global js assets,\n    // reset js option with new file paths\n    if (huron.js.length) {\n      opts.js = opts.js.concat(\n        moveAdditionalAssets(huron.js, 'js', huron)\n      );\n    }\n\n    // Push a new plugin for each configured prototype\n    if (Object.keys(opts).length) {\n      newConfig.plugins.push(\n        new HTMLWebpackPlugin(opts)\n      );\n    }\n  });\n\n  return newConfig;\n}\n\n/**\n * Move relative (and local) js and css assets provided in huron options\n *\n * @param {array|string} assets - array of assets or single asset\n * @param {string} subdir - subdirectory in huron root from which to load additional asset\n * @param {object} huron - huron configuration object\n * @return {array} assetResults - paths to js and css assets\n */\nfunction moveAdditionalAssets(assets, subdir = '', huron) {\n  const currentAssets = [].concat(assets);\n  const assetResults = [];\n\n  currentAssets.forEach((asset) => {\n    const assetInfo = path.parse(asset);\n    const assetURL = url.parse(asset);\n    const sourcePath = path.join(cwd, asset);\n    const outputPath = path.resolve(cwd, huron.root, subdir, assetInfo.base);\n    const loadPath = program.production ?\n      path.join(subdir, assetInfo.base) :\n      path.join('/', subdir, assetInfo.base); // Use absolute path in development\n    let contents = false;\n\n    if (\n      ! path.isAbsolute(asset) &&\n      ! assetURL.protocol\n    ) {\n      try {\n        contents = fs.readFileSync(sourcePath);\n      } catch (e) {\n        console.warn(`could not read ${sourcePath}`);\n      }\n\n      if (contents) {\n        fs.outputFileSync(outputPath, contents);\n        assetResults.push(loadPath);\n      }\n    } else {\n      assetResults.push(asset);\n    }\n  });\n\n  return assetResults;\n}\n"]}