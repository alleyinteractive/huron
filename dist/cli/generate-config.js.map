{"version":3,"sources":["../../src/cli/generate-config.js"],"names":["generateConfig","defaultConfig","require","webpack","path","url","fs","HTMLWebpackPlugin","cwd","process","config","newConfig","huron","Object","assign","configureEntries","configurePlugins","configureLoaders","configurePrototypes","output","resolve","root","devServer","production","publicPath","port","entry","join","plugins","length","filter","plugin","constructor","name","push","HotModuleReplacementPlugin","templatesLoader","templates","loader","include","module","loaders","test","wrapperTemplate","readFileSync","__dirname","defaultHTMLPluginOptions","title","window","js","css","filename","template","inject","chunks","outputFileSync","prototypes","forEach","prototype","newPrototype","opts","hasOwnProperty","call","moveAdditionalAssets","concat","keys","assets","subdir","currentAssets","assetResults","asset","assetInfo","parse","assetURL","sourcePath","outputPath","base","loadPath","contents","isAbsolute","protocol","e","console","warn"],"mappings":"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","file":"generate-config.js","sourcesContent":["/** @module cli/generate-config */\n\nimport program from './parse-args';\n\nconst defaultConfig = require('../../config/webpack.config');\nconst webpack = require('webpack');\nconst path = require('path');\nconst url = require('url');\nconst fs = require('fs-extra');\nconst HTMLWebpackPlugin = require('html-webpack-plugin');\n\nconst cwd = process.cwd();\n\n/**\n * Generate a mutant hybrid of the huron default webpack config and your local webpack config\n *\n * @function generateConfig\n * @param {object} config - local webpack config\n */\nexport default function generateConfig(config) {\n  let newConfig = config;\n\n  newConfig.huron = Object.assign({}, defaultConfig.huron, config.huron);\n  const huron = newConfig.huron;\n\n  // configure entries\n  newConfig = configureEntries(huron, newConfig);\n\n  // configure plugins\n  newConfig = configurePlugins(huron, newConfig);\n\n  // configure loaders\n  newConfig = configureLoaders(huron, newConfig);\n\n  // Add HTMLWebpackPlugin for each configured prototype\n  newConfig = configurePrototypes(huron, newConfig);\n\n  // Set ouput options\n  newConfig.output = Object.assign({}, newConfig.output, defaultConfig.output);\n  newConfig.output.path = path.resolve(cwd, huron.root);\n\n  // Remove existing devServer settings\n  delete newConfig.devServer;\n\n  // Set publicPath\n  if (! program.production) {\n    newConfig.output.publicPath = `http://localhost:${huron.port}/${huron.root}`;\n  } else {\n    newConfig.output.publicPath = '';\n  }\n\n  return newConfig;\n}\n\n/**\n * Configure and manage webpack entry points\n *\n * @param {object} huron - huron configuration object\n * @param {object} config - webpack configuration object\n */\nfunction configureEntries(huron, config) {\n  const entry = config.entry[huron.entry];\n  const newConfig = config;\n\n  newConfig.entry = {};\n\n  if (! program.production) {\n    newConfig.entry[huron.entry] = [\n      `webpack-dev-server/client?http://localhost:${huron.port}`,\n      'webpack/hot/dev-server',\n      path.join(cwd, huron.root, 'huron-assets/huron'),\n      ...entry,\n    ];\n  } else {\n    newConfig.entry[huron.entry] = [\n      path.join(cwd, huron.root, 'huron-assets/huron'),\n      ...entry,\n    ];\n  }\n\n  return newConfig;\n}\n\n/**\n * Configure and manage webpack plugins\n *\n * @param {object} huron - huron configuration object\n * @param {object} config - webpack configuration object\n */\nfunction configurePlugins(huron, config) {\n  const newConfig = config;\n\n  if (! program.production) {\n    if (newConfig.plugins && newConfig.plugins.length) {\n      newConfig.plugins = newConfig.plugins.filter(\n        (plugin) => 'HotModuleReplacementPlugin' !== plugin.constructor.name\n      );\n    }\n    newConfig.plugins.push(new webpack.HotModuleReplacementPlugin());\n  }\n\n  return newConfig;\n}\n\n/**\n * Configure and manage webpack loaders\n *\n * @param {object} huron - huron configuration object\n * @param {object} config - webpack configuration object\n */\nfunction configureLoaders(huron, config) {\n  // Manage loaders\n  const templatesLoader = huron.templates.loader;\n  const newConfig = config;\n\n  templatesLoader.include = [path.join(cwd, huron.root)];\n  newConfig.module = newConfig.module || {};\n  newConfig.module.loaders = newConfig.module.loaders || [];\n  newConfig.module.loaders.push(\n    {\n      test: /\\.html$/,\n      loaders: ['html'],\n      include: [path.join(cwd, huron.root)],\n    },\n    {\n      test: /\\.json$/,\n      loaders: ['json'],\n      include: [path.join(cwd, huron.root)],\n    },\n    templatesLoader\n  );\n\n  return newConfig;\n}\n\n/**\n * Create an HTML webpack plugin for each configured prototype\n *\n * @param {object} huron - huron configuration object\n * @param {object} config - webpack configuration object\n */\nfunction configurePrototypes(huron, config) {\n  const wrapperTemplate = fs.readFileSync(\n    path.join(__dirname, '../../templates/prototype-template.ejs'),\n    'utf8'\n  );\n  const defaultHTMLPluginOptions = {\n    title: '',\n    window: huron.window,\n    js: [],\n    css: [],\n    filename: 'index.html',\n    template: path.join(huron.root, 'huron-assets/prototype-template.ejs'),\n    inject: false,\n    chunks: [huron.entry],\n  };\n  const newConfig = config;\n\n  // Write prototype template file for HTML webpack plugin\n  fs.outputFileSync(\n    path.join(cwd, huron.root, 'huron-assets/prototype-template.ejs'),\n    wrapperTemplate\n  );\n\n  huron.prototypes.forEach((prototype) => {\n    const newPrototype = prototype;\n    let opts = {};\n\n    // Merge configured settings with default settings\n    if ('string' === typeof prototype) {\n      opts = Object.assign({}, defaultHTMLPluginOptions, {\n        title: prototype,\n        filename: `${prototype}.html`,\n      });\n    } else if (\n      'object' === typeof prototype &&\n      {}.hasOwnProperty.call(prototype, 'title')\n    ) {\n      // Create filename based on configured title if not provided\n      if (! prototype.filename) {\n        newPrototype.filename = `${prototype.title}.html`;\n      }\n\n      // Move css assets for this prototype,\n      // reset css option with new file paths\n      if (prototype.css) {\n        newPrototype.css = moveAdditionalAssets(prototype.css, 'css', huron);\n      }\n\n      // Move js assets for this prototype,\n      // reset js option with new file paths\n      if (prototype.js) {\n        newPrototype.js = moveAdditionalAssets(prototype.js, 'js', huron);\n      }\n\n      opts = Object.assign({}, defaultHTMLPluginOptions, newPrototype);\n    }\n\n    // Move global css assets,\n    // reset css option with new file paths\n    if (huron.css.length) {\n      opts.css = opts.css.concat(\n        moveAdditionalAssets(huron.css, 'css', huron)\n      );\n    }\n\n    // Move global js assets,\n    // reset js option with new file paths\n    if (huron.js.length) {\n      opts.js = opts.js.concat(\n        moveAdditionalAssets(huron.js, 'js', huron)\n      );\n    }\n\n    // Push a new plugin for each configured prototype\n    if (Object.keys(opts).length) {\n      newConfig.plugins.push(\n        new HTMLWebpackPlugin(opts)\n      );\n    }\n  });\n\n  return newConfig;\n}\n\n/**\n * Move relative (and local) js and css assets provided in huron options\n *\n * @param {array|string} assets - array of assets or single asset\n * @param {string} subdir - subdirectory in huron root from which to load additional asset\n * @param {object} huron - huron configuration object\n */\nfunction moveAdditionalAssets(assets, subdir = '', huron) {\n  const currentAssets = [].concat(assets);\n  const assetResults = [];\n\n  currentAssets.forEach((asset) => {\n    const assetInfo = path.parse(asset);\n    const assetURL = url.parse(asset);\n    const sourcePath = path.join(cwd, asset);\n    const outputPath = path.resolve(cwd, huron.root, subdir, assetInfo.base);\n    const loadPath = program.production ?\n      path.join(subdir, assetInfo.base) :\n      path.join('/', subdir, assetInfo.base); // Use absolute path in development\n    let contents = false;\n\n    if (\n      ! path.isAbsolute(asset) &&\n      ! assetURL.protocol\n    ) {\n      try {\n        contents = fs.readFileSync(sourcePath);\n      } catch (e) {\n        console.warn(`could not read ${sourcePath}`);\n      }\n\n      if (contents) {\n        fs.outputFileSync(outputPath, contents);\n        assetResults.push(loadPath);\n      }\n    } else {\n      assetResults.push(asset);\n    }\n  });\n\n  return assetResults;\n}\n"]}